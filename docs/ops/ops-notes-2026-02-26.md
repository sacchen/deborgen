# Ops Notes (2026-02-26)

This document records the exact setup completed today for the deborgen coordinator + worker demo.

## Topology

- Droplet (`deborgen-coord-01`) = coordinator
- Mac laptop = worker + submitter
- Connectivity = Tailscale

## Final Working State

- Coordinator is running under `systemd` on port `8000`.
- Health endpoint works over Tailscale:
  - `curl http://<tailscale-ip>:8000/health` -> `{"status":"ok"}`
- Worker can register and execute jobs when started with:
  - `uv run python -m deborgen.worker.agent ...`
- SSH works using key auth for:
  - `dev` (primary)
  - `rescue` (break-glass fallback)

## Important Gotchas Found

- Worker entrypoint is **not** `deborgen.worker`; it is:
  - `deborgen.worker.agent`
- Placeholder tokens caused `401` (`invalid auth token`) until replaced with a real secret.
- Worker appears to "hang" when idle; this is expected (poll loop).
- Tailscale hostname tests were confusing; direct `100.x.y.z` IP was clearer.

## Coordinator Service

Service file:

- `/etc/systemd/system/deborgen-coordinator.service`

Environment file:

- `/etc/deborgen/coordinator.env`

Current env keys:

- `DEBORGEN_DB_PATH=/home/dev/deborgen/deborgen.db`
- `DEBORGEN_TOKEN=<real-random-token>`

Service command:

```bash
uv run uvicorn deborgen.coordinator.app:app --host 0.0.0.0 --port 8000
```

Useful commands:

```bash
sudo systemctl status deborgen-coordinator
sudo systemctl restart deborgen-coordinator
sudo journalctl -u deborgen-coordinator -f
```

## Security Decisions

### SSH

Enforced:

- `PermitRootLogin no`
- `PasswordAuthentication no`
- `PubkeyAuthentication yes`

Validated login paths:

- `ssh dev@<tailscale-ip>`
- `ssh -i ~/.ssh/id_ed25519_rescue -o IdentitiesOnly=yes rescue@<tailscale-ip>`

### Secret Handling

- Server token is stored in `/etc/deborgen/coordinator.env` (root-owned, mode `600`).
- Laptop token is intended to be loaded from macOS Keychain, not stored in shell rc.

Example runtime load:

```bash
export DEBORGEN_TOKEN="$(security find-generic-password -a "$USER" -s deborgen_token -w)"
```

## Tailscale / Access Model

Goal:

- Friend can access old/shared droplet only.
- New droplet is private.

Tags:

- Old droplet: `tag:shared`
- New droplet: `tag:private`

ACL model used:

- `group:me` -> `tag:private:*`
- `group:shared` -> `tag:shared:*`

Note: identity strings in ACL groups must exactly match Tailscale identities.

## Laptop Worker Convenience

Script added:

- `~/bin/deborgen-worker-start`

Expected usage:

```bash
cd /Users/goddess/foundry/sandbox/deborgen
export DEBORGEN_TOKEN="$(security find-generic-password -a "$USER" -s deborgen_token -w)"
deborgen-worker-start
```

Also set:

```bash
export DEBORGEN_COORDINATOR_URL='http://<tailscale-ip>:8000'
```

## Basic Smoke Test

Submit:

```bash
curl -sS -H "Authorization: Bearer $DEBORGEN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"command":"echo hello from worker"}' \
  http://<tailscale-ip>:8000/jobs
```

Check:

```bash
curl -sS -H "Authorization: Bearer $DEBORGEN_TOKEN" http://<tailscale-ip>:8000/jobs/job_1
curl -sS -H "Authorization: Bearer $DEBORGEN_TOKEN" http://<tailscale-ip>:8000/jobs/job_1/logs
```

## Recovery Checklist

1. Keep both `dev` and `rescue` keys tested.
2. Keep at least one active SSH session open while editing SSH/firewall.
3. If locked out:
   - Use DigitalOcean recovery mode
   - Mount root disk and restore `authorized_keys` + `sshd_config`
4. Take a droplet snapshot after stable config changes.
